import utils
from ecpy.curves import Curve, Point
from ecpy.keys import ECPrivateKey, ECPublicKey
from ldei import LDEI

# Auxiliary function to print in stdout a encoded list of points, usefull for debugging
def printPointListEncoded(pointList : list[Point], curve : Curve):
    for point in pointList:
        print(curve.encode_point(point))

if __name__ == "__main__":

    curve = Curve.get_curve('secp256k1')

    n = 11
    t = int(n/3)
    q = curve._domain["order"]
    
    l = int(n - 2 * t)

    scalars = [106, 402, 51, 118, 27, 24, 186, 408, 282, 90, 10]

    pks : list[Point] = []


    for scalar in scalars:
      sk = ECPrivateKey(scalar, curve)
      pk = sk.get_public_key()
      pks.append(pk.W)  


    # Test compute polynomial

    polynomial : list[int] = [111952925409827623653256139075928328189643159161620610900815630149181367693938, 61024504524286397130694724064219412316097097636549249833634020179433101810954,
                               76749015777356831480356137495015518635149363292497439778244534088012444645411, 21973838643146125886167961981630672820664120595679980669784701972101514458373,
                                 64878477606357345417873488761911626682337560636641222159096216208599077486641, 99355011838136682670583249796267478931435901008755968637327935030101064312818,
                                   91828543453734048129209428351084674566459856282273681791617837048263202139603, 46661535303975665740162732559829810071659798814544487859503283960005752205420,
                                     91294012868505506828948584462276980732389750644046132503719156675433863522376]


    result_polynomial : list[int] = [-1] * int(l)
    for i in range(0,int(l)):
        result_polynomial[i] = utils.evalPoly(polynomial, i) % q


    assert(result_polynomial == [91294012868505506828948584462276980732389750644046132503719156675433863522376, 86757419238745249819397521504724963681648786677234252220717499603540580803849,
                                  6850056924828707288159204961756057940700621128549752667693911921829998379500, 5588726106570884331459447133657410919223174595449075558699835558298624019233,
                                    50645546026469819168919422676949112535649219089399444487452206284185938151224])

    # Test generation of shares

    shares, encryptedShares = utils.computePolynomialEC(polynomial,pks, n, q)

    auxEncryptedResultShares = [[4, 178, 43, 111, 75, 73, 67, 141, 229, 80, 213, 209, 196, 52, 78, 215, 251, 145, 84, 159, 199, 158, 109, 170, 141, 251, 247, 61, 10, 63, 253, 134, 221, 209, 42, 130, 191, 193, 9, 16, 209, 35, 74, 184, 106, 207, 50, 206, 149, 43, 217, 233, 52, 52, 53, 50, 102, 87, 201, 133, 236, 98, 173, 38, 75],
[4, 34, 54, 93, 174, 89, 115, 31, 138, 24, 212, 188, 54, 60, 232, 207, 54, 97, 2, 54, 135, 230, 17, 110, 161, 234, 201, 124, 37, 105, 149, 44, 45, 159, 95, 176, 18, 182, 234, 17, 100, 228, 225, 15, 11, 150, 197, 236, 249, 217, 91, 41, 107, 255, 23, 45, 218, 131, 172, 15, 67, 56, 93, 64, 235],
[4, 86, 6, 189, 91, 207, 83, 232, 128, 234, 162, 228, 205, 174, 80, 236, 121, 80, 79, 101, 170, 125, 160, 23, 118, 121, 152, 62, 219, 85, 251, 238, 139, 250, 208, 210, 177, 35, 149, 126, 167, 37, 98, 133, 177, 222, 207, 36, 165, 232, 82, 85, 52, 186, 177, 238, 148, 166, 231, 109, 163, 101, 93, 213, 196],
[4, 199, 70, 101, 69, 5, 48, 34, 80, 15, 12, 15, 219, 192, 140, 103, 213, 166, 168, 57, 229, 110, 23, 95, 253, 60, 133, 148, 30, 210, 84, 214, 212, 61, 22, 74, 175, 171, 250, 125, 110, 224, 151, 212, 122, 172, 71, 21, 142, 48, 220, 152, 208, 129, 137, 237, 183, 132, 103, 1, 63, 68, 206, 103, 124],
[4, 114, 161, 124, 76, 160, 37, 11, 100, 28, 103, 241, 105, 39, 189, 116, 136, 243, 16, 220, 40, 226, 169, 85, 94, 57, 89, 92, 139, 187, 157, 100, 126, 118, 180, 65, 217, 186, 91, 45, 253, 58, 200, 210, 23, 193, 202, 251, 122, 138, 207, 81, 31, 43, 246, 145, 116, 128, 10, 64, 151, 243, 101, 203, 70],
[4, 192, 22, 11, 242, 251, 8, 186, 110, 177, 238, 232, 225, 9, 11, 177, 64, 213, 86, 171, 105, 124, 2, 98, 53, 10, 218, 229, 191, 157, 50, 191, 177, 141, 45, 40, 216, 195, 33, 136, 227, 236, 175, 137, 69, 53, 207, 146, 205, 101, 127, 223, 130, 87, 130, 31, 129, 210, 200, 239, 214, 71, 230, 168, 205],
[4, 100, 176, 169, 175, 152, 54, 252, 15, 116, 194, 128, 121, 233, 66, 86, 112, 105, 198, 175, 84, 201, 160, 41, 121, 183, 142, 32, 170, 219, 204, 102, 44, 207, 139, 110, 75, 190, 243, 114, 147, 61, 45, 240, 152, 109, 229, 37, 85, 113, 43, 80, 94, 5, 221, 3, 184, 114, 135, 32, 167, 131, 207, 21, 82],
[4, 204, 177, 83, 113, 66, 148, 223, 219, 47, 201, 25, 237, 116, 29, 188, 174, 58, 183, 94, 123, 185, 72, 106, 222, 169, 204, 150, 204, 165, 163, 154, 209, 212, 122, 76, 60, 128, 82, 254, 202, 183, 67, 11, 170, 108, 98, 195, 182, 215, 134, 117, 128, 177, 179, 138, 23, 214, 15, 179, 212, 34, 120, 119, 81],
[4, 93, 227, 55, 81, 116, 185, 1, 130, 61, 249, 41, 91, 92, 245, 82, 59, 195, 112, 220, 134, 248, 243, 106, 24, 59, 110, 97, 213, 164, 162, 177, 200, 155, 50, 38, 87, 230, 193, 115, 218, 128, 96, 61, 244, 114, 196, 194, 200, 166, 109, 39, 84, 119, 175, 81, 94, 145, 27, 10, 110, 236, 122, 224, 1],
[4, 207, 164, 204, 230, 187, 157, 131, 255, 23, 10, 92, 78, 62, 80, 253, 155, 11, 1, 18, 123, 99, 14, 140, 254, 195, 151, 146, 90, 8, 144, 194, 30, 59, 41, 223, 4, 113, 35, 15, 166, 181, 86, 17, 190, 11, 142, 22, 80, 148, 78, 165, 77, 41, 65, 241, 127, 200, 41, 253, 145, 249, 249, 73, 112],
[4, 233, 115, 232, 4, 234, 188, 48, 203, 15, 43, 65, 182, 201, 155, 70, 214, 78, 81, 15, 111, 16, 238, 37, 137, 195, 252, 77, 61, 182, 15, 248, 217, 189, 18, 114, 121, 120, 183, 178, 118, 247, 101, 150, 190, 242, 227, 57, 146, 202, 96, 91, 203, 155, 60, 60, 75, 90, 43, 116, 185, 206, 11, 234, 249]] 

    resultEncryptedPoints : list[Point] = []

    for point in auxEncryptedResultShares:
        resultEncryptedPoints.append(curve.decode_point(point))

    assert(encryptedShares == resultEncryptedPoints)

    # Test generation LDEI

    auxPolynomial = [98985430576587857143619378541665444510850581754958443955198330520966312679420, 56069919451247143660106002637012620277130539451016000248239121040458859081894,
                      98142171112318555870121839315617648323377549922720500459868443212279709716869, 42210272668401663740840306612588159928794391892658669113083411743063782112271,
                        28630637831837315386012361903672858449793389244435777280307008785531962479220, 41381146901790931769295974691196402147654200468396653298586486041782867240499,
                          16840664938268810498906576240753331773145281049250483552163421895143342699899, 49153761387413071439160624007522351200082663824908985695986614707668204590817,
                            102776361802069628841255711949790633466552440922590208947461862753825086854663]


    a,e,z = utils.generateLDEI_EC_NonRandom(polynomial, encryptedShares, pks, n, q, auxPolynomial)

    ldei = LDEI(a,e,z)

    auxALDEI = [[4, 117, 65, 200, 214, 37, 153, 236, 218, 16, 118, 89, 16, 132, 112, 202, 119, 59, 238, 69, 63, 1, 201, 185, 228, 41, 247, 45, 250, 101, 8, 68, 24, 132, 63, 229, 170, 54, 248, 216, 253, 11, 153, 210, 232, 220, 175, 181, 10, 211, 160, 61, 251, 56, 89, 241, 203, 129, 48, 255, 185, 16, 88, 162, 192],
[4, 212, 179, 67, 162, 45, 26, 181, 147, 47, 226, 174, 77, 180, 95, 88, 2, 89, 119, 31, 204, 176, 34, 181, 48, 253, 193, 77, 153, 90, 243, 59, 199, 132, 187, 69, 66, 113, 11, 183, 0, 136, 99, 219, 191, 137, 102, 177, 95, 212, 174, 71, 171, 27, 167, 151, 115, 73, 56, 78, 63, 67, 136, 159, 64],
[4, 191, 78, 17, 29, 221, 169, 124, 53, 103, 206, 32, 197, 190, 28, 197, 193, 46, 119, 174, 182, 176, 33, 122, 97, 92, 95, 10, 66, 235, 232, 35, 200, 73, 236, 115, 24, 14, 35, 188, 60, 86, 235, 15, 113, 219, 77, 119, 95, 88, 158, 208, 78, 133, 166, 77, 105, 227, 103, 100, 11, 181, 254, 55, 81],
[4, 29, 13, 255, 51, 223, 14, 198, 154, 98, 196, 64, 122, 194, 182, 217, 29, 78, 152, 10, 197, 251, 180, 113, 4, 43, 111, 228, 33, 66, 19, 151, 147, 246, 12, 110, 134, 143, 1, 253, 235, 140, 56, 31, 74, 71, 67, 79, 50, 192, 159, 116, 130, 139, 76, 45, 230, 219, 130, 199, 127, 187, 135, 98, 52],
[4, 76, 103, 63, 208, 19, 149, 22, 195, 240, 113, 101, 250, 39, 32, 202, 48, 228, 249, 244, 248, 58, 104, 18, 76, 117, 74, 195, 96, 249, 60, 170, 200, 147, 249, 48, 72, 227, 75, 170, 84, 66, 126, 17, 91, 245, 149, 48, 127, 241, 161, 231, 227, 205, 29, 120, 122, 137, 59, 96, 86, 218, 72, 80, 79],
[4, 226, 122, 186, 143, 192, 112, 52, 243, 253, 51, 68, 6, 63, 184, 97, 57, 13, 113, 111, 227, 1, 83, 11, 111, 121, 233, 113, 252, 7, 229, 120, 15, 114, 181, 203, 71, 43, 187, 159, 81, 181, 172, 128, 212, 102, 185, 2, 26, 62, 38, 84, 82, 50, 53, 183, 22, 124, 122, 146, 92, 249, 69, 13, 22],
[4, 59, 135, 201, 174, 112, 30, 120, 135, 39, 122, 250, 231, 203, 143, 153, 158, 52, 67, 23, 111, 101, 207, 35, 8, 116, 220, 82, 30, 198, 84, 22, 207, 109, 24, 197, 66, 162, 207, 210, 126, 193, 6, 167, 91, 112, 113, 89, 238, 181, 55, 18, 159, 26, 60, 243, 230, 84, 166, 174, 229, 130, 72, 95, 159],
[4, 235, 148, 100, 120, 44, 11, 38, 182, 171, 147, 173, 126, 125, 135, 73, 253, 17, 246, 0, 17, 1, 181, 38, 97, 197, 42, 164, 190, 216, 44, 90, 203, 175, 228, 149, 2, 120, 30, 223, 121, 152, 134, 90, 113, 35, 134, 206, 245, 156, 107, 160, 0, 140, 41, 34, 254, 228, 0, 95, 13, 122, 50, 90, 177],
[4, 243, 137, 154, 139, 184, 182, 170, 235, 46, 215, 179, 13, 64, 107, 197, 110, 124, 149, 119, 113, 248, 136, 181, 36, 97, 251, 125, 76, 70, 254, 183, 246, 31, 157, 178, 229, 235, 56, 125, 12, 254, 200, 241, 112, 232, 193, 158, 183, 168, 70, 232, 55, 72, 164, 219, 77, 152, 140, 92, 20, 37, 63, 218, 243],
[4, 32, 23, 50, 10, 254, 110, 79, 10, 168, 131, 81, 91, 22, 22, 233, 44, 246, 189, 227, 4, 101, 26, 37, 252, 231, 81, 53, 6, 86, 178, 56, 142, 53, 90, 89, 160, 63, 112, 255, 67, 0, 255, 68, 146, 255, 252, 72, 194, 223, 130, 74, 96, 190, 17, 97, 170, 23, 54, 244, 165, 210, 207, 52, 62],
[4, 195, 227, 102, 4, 249, 138, 216, 27, 23, 14, 234, 73, 76, 162, 105, 43, 218, 205, 95, 49, 146, 27, 218, 238, 77, 33, 151, 46, 173, 180, 35, 59, 51, 233, 19, 17, 96, 148, 64, 33, 76, 191, 177, 32, 202, 225, 186, 110, 199, 92, 181, 91, 226, 194, 57, 146, 106, 163, 136, 249, 74, 209, 53, 216]]
    
    resultALDEI :list[Point] = []

    for point in auxALDEI:
        resultALDEI.append(curve.decode_point(point))

    resultLDEI = LDEI(resultALDEI,
                      95389965746686860860716459239980183321319263411941432709255012215074048220460,
                      [31002863125198244047361445012175469258059203591521473380568089833869574734511, 44193177632521850742809783624461266140859364820469280581584736679038023509043,
                        86859160125464159929679122310464479991117725188408610787487094348419341792864, 53541015141149472513244520529025413543791743620755604283091732467699182918980,
                          90499370790767098035609993651595275467137527189630607882891461278892729872898, 66309870038064001130099162884869272455325369875856053753785973679953874378327,
                            55433323337457391684438572297364634969808776364229876303168920452305322745336, 47345654330492126726551111338681047807423710230800569267298931585890415738726,
                              43000390037471022967262291129926907771287483506277156440513562723021007390623])

    assert(ldei == resultLDEI)

    # Test validation LDEI

    assert(utils.verifyLDEI_EC(ldei, pks, encryptedShares, n, t+l, q))


    print("ALBATROSS with Elliptic Curves test finished sucessfully!")


    