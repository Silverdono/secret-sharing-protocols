import utils
from ecpy.curves import Curve, Point
from ecpy.keys import ECPrivateKey, ECPublicKey
from ldei import LDEI

def printPointListEncoded(pointList : list[Point], curve : Curve):
    for point in pointList:
        print(curve.encode_point(point))

if __name__ == "__main__":

    curve = Curve.get_curve('secp256k1')

    n = 11
    t = int(n/3)
    q = curve._domain["order"]
    
    l = int(n - 2 * t)

    sk = ECPrivateKey(20, curve)
    pk = sk.get_public_key()
    pks : list[ECPublicKey] = [pk] * int(n)

    # Test compute polynomial

    polynomial : list[int] = [111952925409827623653256139075928328189643159161620610900815630149181367693938, 61024504524286397130694724064219412316097097636549249833634020179433101810954,
                               76749015777356831480356137495015518635149363292497439778244534088012444645411, 21973838643146125886167961981630672820664120595679980669784701972101514458373,
                                 64878477606357345417873488761911626682337560636641222159096216208599077486641, 99355011838136682670583249796267478931435901008755968637327935030101064312818,
                                   91828543453734048129209428351084674566459856282273681791617837048263202139603, 46661535303975665740162732559829810071659798814544487859503283960005752205420,
                                     91294012868505506828948584462276980732389750644046132503719156675433863522376]


    result_polynomial : list[int] = [-1] * int(l)
    for i in range(0,int(l)):
        result_polynomial[i] = utils.evalPoly(polynomial, i) % q


    assert(result_polynomial == [91294012868505506828948584462276980732389750644046132503719156675433863522376, 86757419238745249819397521504724963681648786677234252220717499603540580803849,
                                  6850056924828707288159204961756057940700621128549752667693911921829998379500, 5588726106570884331459447133657410919223174595449075558699835558298624019233,
                                    50645546026469819168919422676949112535649219089399444487452206284185938151224])

    # Test generation of shares

    shares, encryptedShares = utils.computePolynomialEC(polynomial,pk.W, n, q)


    auxEncryptedResultShares = [[4, 84, 30, 78, 127, 11, 130, 40, 160, 167, 10, 171, 63, 152, 197, 10, 84, 254, 189, 83, 196, 237, 51, 129, 191, 103, 121, 133, 201, 76, 99, 206, 158, 210, 56, 210, 5, 36, 129, 21, 197, 239, 82, 153, 100, 20, 124, 254, 77, 131, 5, 134, 87, 225, 77, 52, 204, 42, 235, 183, 208, 100, 180, 126, 198],
[4, 180, 206, 147, 66, 66, 139, 137, 246, 23, 176, 145, 223, 34, 183, 146, 12, 248, 148, 4, 186, 184, 36, 122, 2, 45, 126, 186, 41, 216, 82, 27, 202, 186, 9, 179, 233, 185, 230, 182, 29, 92, 107, 129, 148, 49, 204, 158, 4, 157, 90, 196, 150, 55, 232, 106, 200, 228, 111, 79, 139, 208, 48, 252, 66],
[4, 105, 126, 28, 177, 30, 238, 206, 175, 36, 79, 32, 201, 45, 189, 130, 63, 168, 199, 182, 30, 144, 1, 120, 113, 103, 87, 78, 115, 226, 96, 254, 17, 3, 140, 159, 166, 1, 96, 81, 60, 82, 147, 76, 194, 70, 114, 72, 40, 66, 144, 228, 36, 173, 34, 7, 156, 187, 95, 33, 145, 218, 108, 225, 103],
[4, 76, 168, 211, 155, 115, 126, 243, 22, 58, 154, 105, 143, 128, 47, 111, 56, 63, 112, 51, 71, 219, 3, 71, 76, 249, 77, 166, 23, 58, 126, 241, 224, 35, 66, 2, 255, 3, 137, 254, 240, 236, 54, 20, 49, 196, 211, 150, 213, 174, 83, 240, 198, 115, 21, 118, 66, 172, 78, 1, 72, 208, 3, 163, 235],
[4, 161, 125, 176, 193, 40, 80, 202, 165, 239, 241, 208, 175, 227, 67, 113, 105, 67, 113, 214, 168, 172, 191, 47, 8, 169, 208, 1, 203, 35, 205, 36, 23, 214, 118, 90, 89, 4, 104, 198, 88, 61, 103, 255, 50, 15, 214, 245, 221, 82, 3, 152, 122, 251, 27, 210, 29, 242, 168, 236, 177, 188, 134, 198, 34],
[4, 175, 133, 186, 13, 52, 40, 253, 241, 29, 179, 118, 164, 2, 7, 229, 40, 201, 228, 122, 178, 86, 14, 151, 237, 171, 85, 229, 106, 19, 153, 96, 151, 62, 75, 53, 28, 195, 98, 248, 42, 212, 193, 220, 154, 23, 160, 1, 175, 140, 247, 49, 61, 102, 225, 198, 90, 229, 199, 93, 56, 77, 6, 180, 135],
[4, 73, 210, 170, 35, 222, 114, 245, 251, 17, 246, 38, 212, 171, 179, 11, 229, 151, 39, 133, 233, 179, 113, 123, 201, 67, 4, 237, 51, 87, 59, 130, 15, 75, 150, 83, 25, 19, 180, 10, 72, 184, 174, 237, 118, 174, 219, 109, 31, 98, 154, 118, 161, 198, 13, 189, 40, 94, 55, 5, 20, 195, 119, 186, 14],
[4, 57, 52, 100, 8, 132, 102, 63, 12, 203, 81, 135, 245, 147, 249, 73, 75, 151, 76, 232, 208, 38, 213, 40, 140, 227, 38, 46, 105, 185, 135, 81, 81, 43, 21, 13, 115, 29, 238, 217, 47, 75, 135, 186, 212, 147, 47, 192, 207, 191, 231, 71, 78, 175, 64, 167, 243, 166, 152, 186, 247, 229, 14, 174, 97],
[4, 113, 114, 220, 45, 113, 234, 127, 208, 6, 120, 223, 96, 51, 84, 58, 162, 208, 251, 241, 182, 14, 231, 5, 14, 22, 227, 230, 217, 129, 23, 119, 240, 166, 65, 153, 190, 61, 74, 159, 147, 35, 206, 196, 174, 51, 73, 11, 14, 179, 100, 219, 197, 252, 101, 187, 254, 226, 73, 111, 42, 241, 69, 233, 145],
[4, 73, 229, 218, 154, 157, 246, 188, 120, 27, 172, 90, 66, 102, 173, 63, 146, 201, 228, 52, 190, 214, 249, 88, 27, 183, 160, 196, 158, 103, 153, 179, 187, 223, 115, 87, 94, 68, 249, 7, 194, 5, 152, 168, 135, 125, 182, 173, 250, 123, 200, 98, 41, 252, 196, 12, 71, 26, 193, 240, 22, 65, 19, 201, 176],
[4, 115, 160, 12, 56, 176, 152, 194, 65, 160, 130, 31, 16, 83, 19, 215, 179, 197, 244, 48, 188, 204, 58, 47, 190, 143, 87, 147, 90, 104, 215, 155, 97, 146, 226, 252, 39, 8, 233, 12, 254, 137, 204, 246, 211, 79, 105, 87, 170, 37, 243, 96, 117, 24, 91, 214, 235, 227, 118, 234, 79, 126, 27, 84, 231]] 

    resultEncryptedPoints : list[Point] = []

    for point in auxEncryptedResultShares:
        resultEncryptedPoints.append(curve.decode_point(point))

    assert(encryptedShares == resultEncryptedPoints)

    # Test generation LDEI

    auxPolynomial = [98985430576587857143619378541665444510850581754958443955198330520966312679420, 56069919451247143660106002637012620277130539451016000248239121040458859081894,
                      98142171112318555870121839315617648323377549922720500459868443212279709716869, 42210272668401663740840306612588159928794391892658669113083411743063782112271,
                        28630637831837315386012361903672858449793389244435777280307008785531962479220, 41381146901790931769295974691196402147654200468396653298586486041782867240499,
                          16840664938268810498906576240753331773145281049250483552163421895143342699899, 49153761387413071439160624007522351200082663824908985695986614707668204590817,
                            102776361802069628841255711949790633466552440922590208947461862753825086854663]


    a,e,z = utils.generateLDEI_EC_NonRandom(polynomial, encryptedShares, pks, n, q, auxPolynomial)

    ldei = LDEI(a,e,z)

    auxALDEI = [[4, 12, 96, 98, 32, 81, 132, 221, 227, 22, 39, 14, 219, 189, 36, 33, 62, 52, 95, 182, 67, 66, 31, 146, 223, 93, 78, 99, 37, 225, 51, 184, 109, 196, 56, 102, 88, 81, 163, 185, 199, 46, 26, 177, 33, 37, 174, 30, 46, 167, 38, 202, 71, 212, 94, 16, 144, 64, 94, 249, 161, 58, 150, 34, 214],
[4, 122, 162, 251, 56, 171, 195, 108, 255, 171, 65, 94, 66, 133, 115, 168, 91, 85, 151, 117, 104, 26, 185, 216, 49, 70, 194, 69, 91, 102, 27, 147, 12, 220, 3, 238, 244, 225, 207, 47, 185, 231, 243, 85, 74, 188, 194, 195, 138, 214, 102, 45, 21, 118, 104, 161, 133, 130, 57, 197, 118, 83, 77, 157, 48],
[4, 56, 45, 35, 91, 65, 35, 123, 58, 209, 223, 140, 183, 114, 84, 183, 23, 49, 90, 230, 48, 211, 169, 143, 234, 115, 58, 99, 155, 171, 166, 205, 109, 28, 5, 179, 8, 22, 140, 254, 4, 228, 229, 241, 82, 228, 40, 251, 184, 41, 208, 154, 112, 155, 145, 137, 39, 109, 55, 197, 207, 240, 153, 155, 208],
[4, 163, 39, 226, 238, 7, 158, 100, 229, 63, 56, 215, 136, 52, 248, 205, 219, 101, 60, 155, 25, 80, 226, 47, 56, 214, 172, 11, 209, 233, 220, 154, 107, 48, 239, 141, 121, 109, 153, 133, 47, 7, 254, 109, 46, 16, 233, 219, 234, 148, 70, 114, 172, 204, 212, 212, 86, 150, 58, 146, 100, 47, 250, 255, 218],
[4, 199, 23, 129, 59, 41, 172, 18, 225, 192, 249, 124, 154, 208, 63, 251, 63, 122, 203, 146, 15, 94, 12, 172, 216, 144, 5, 179, 118, 232, 64, 200, 62, 152, 32, 209, 168, 96, 213, 116, 135, 228, 210, 119, 61, 173, 72, 45, 49, 120, 30, 167, 218, 179, 78, 122, 150, 128, 1, 104, 118, 81, 181, 247, 124],
[4, 87, 67, 160, 218, 217, 45, 118, 29, 3, 103, 254, 188, 225, 231, 144, 124, 178, 161, 16, 71, 46, 23, 178, 138, 73, 111, 136, 217, 199, 71, 139, 217, 89, 47, 23, 2, 216, 133, 215, 43, 94, 52, 221, 156, 66, 54, 144, 173, 253, 183, 72, 133, 156, 102, 20, 78, 221, 254, 214, 96, 40, 10, 207, 35],
[4, 188, 83, 81, 240, 169, 129, 173, 168, 107, 210, 177, 30, 230, 71, 155, 175, 172, 192, 226, 187, 4, 49, 250, 101, 125, 108, 125, 94, 104, 7, 12, 160, 140, 125, 206, 241, 159, 63, 176, 254, 226, 240, 4, 164, 232, 231, 187, 70, 160, 146, 222, 39, 44, 79, 244, 191, 113, 186, 219, 167, 65, 98, 132, 67],
[4, 92, 36, 50, 93, 55, 9, 60, 189, 37, 2, 234, 255, 1, 220, 137, 109, 140, 176, 227, 87, 57, 179, 252, 48, 147, 132, 14, 157, 125, 227, 194, 36, 222, 30, 62, 151, 237, 89, 9, 225, 113, 39, 31, 203, 11, 102, 3, 93, 67, 137, 208, 117, 45, 151, 61, 32, 75, 83, 8, 137, 155, 111, 106, 99],
[4, 114, 224, 8, 222, 40, 237, 168, 235, 167, 99, 61, 182, 59, 99, 231, 58, 161, 18, 177, 252, 197, 179, 86, 131, 91, 89, 144, 81, 194, 223, 38, 90, 20, 58, 55, 98, 3, 187, 59, 47, 53, 222, 46, 218, 79, 153, 190, 249, 189, 216, 55, 255, 136, 129, 129, 89, 202, 186, 169, 81, 21, 224, 140, 162],
[4, 23, 87, 184, 171, 178, 6, 12, 158, 203, 125, 3, 143, 64, 10, 163, 97, 215, 187, 161, 194, 151, 205, 221, 180, 233, 194, 36, 189, 100, 166, 71, 43, 122, 57, 242, 234, 142, 25, 185, 65, 79, 178, 35, 158, 205, 48, 140, 89, 121, 105, 71, 35, 151, 210, 70, 152, 99, 134, 172, 203, 170, 84, 6, 123],
[4, 58, 229, 179, 114, 228, 67, 179, 225, 159, 250, 244, 46, 245, 252, 204, 45, 3, 33, 38, 106, 237, 20, 210, 141, 150, 75, 105, 137, 108, 41, 92, 42, 1, 230, 119, 150, 174, 198, 196, 231, 242, 158, 6, 245, 54, 19, 160, 253, 48, 56, 186, 218, 122, 62, 105, 171, 230, 251, 39, 132, 176, 177, 233, 129]]
    
    resultALDEI :list[Point] = []

    for point in auxALDEI:
        resultALDEI.append(curve.decode_point(point))

    resultLDEI = LDEI(resultALDEI,
                      18269893574941389695138715662417911933755523922413333256053761210428706633163,
                      [36656251418453876119091023818248661239130577182567841187840496970039120545970, 94767706983902079325404126374860795444007184117265991331572641732600371119815,
                        70048507671463883057590415812765415789336515261278885015454751150362956356512, 98526334360961988959116762722661618739910111149926413023474076042195129430004,
                          91402085957093710722633038903018747785257209808177979231532869834276547973042, 74046405242896556862705375331672689129114795735847575649850959500006873734574,
                            27828037773382473206870351359212064799300864414318827718425437998915673181204, 19584815070693110914499715868182698606416614440957330981774706840924028989245,
                              6347657542508443388168383579702395106408975381412571550044408586933400487193])

    assert(ldei == resultLDEI)

    # Test validation LDEI

    assert(utils.verifyLDEI_EC(ldei, pks, encryptedShares, n, t+l, q))


    print("ALBATROSS with Elliptic Curves test finished sucessfully!")